<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>서울생활인구 · Population by time in Seoul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
  <link rel="stylesheet" href="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.min.css">
  <style>
  html,body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
  }
  #map {
    width: 100%;
    height: 100%;
  }

  .f-left {
    float: left;
  }

  button#play, button#pause {
    width: 60px;
    padding: 10px 5px;
    margin-right: 5px;
    cursor: pointer;
  }
  #timeLabel {
    margin-top: 5px;
  }
  .container, .tab-container {
    width: 300px;
    padding: 10px 20px 10px 20px;
    background-color: rgba(255, 255, 255, 0.7);
  }
  .slider-wrapper {
    margin-bottom: 40px;
  }
  /* noUISlider override */
  .noUi-horizontal {
    height: 10px;
  }
  .noUi-pips-horizontal {
    height: 0;
  }
  .noUi-horizontal .noUi-handle {
    height: 20px;
  }
  .noUi-handle:after, .noUi-handle:before {
    content: none;
  }
  .noUi-connect {
    background: #ccc;
    outline: 1px solid #333;
  }

  .feature-table h5 {
    margin: 0;
  }

  h3 {
    margin-top: 0;
  }
  label {
    font-size: 14px;
    font-weight: 700;
  }

  .tab {
    width: 33.333%;
    display: inline-block;
    float: left;
  }
  </style>
</head>
<body>
  <div id="map">
  </div>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>
  <script src="https://unpkg.com/tangram@0.15.3/dist/tangram.min.js"></script>
  <script src="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.js"></script>
  <script src="./slider_control.js"></script>
  <script>

    function initMap() {
      window.map = L.map('map');

      map.setView([37.58451, 126.96939], 12);

      window.tangramLayer = Tangram.leafletLayer({
        scene: {
          import: './timeline.yaml'
       },
       events: {
         click: function(selection) {
           onTangramClick(selection)
         }
       }
      })

      tangramLayer.addTo(map)
    }

    var PopupPanel = (function () {
        var displayKey = {
          t:'전체',
          f:'여성',
          m:'남성',
          a1: '10대',
          a2: '20대',
          a3: '30대',
          a4: '40대',
          a5: '50대',
          a6: '60대'
        }

        function makeDongHeader(obj) {
          var tableRowElem = document.createElement('tr');
          var nameColElem = document.createElement('h5');
          nameColElem.textContent = obj.name;
          tableRowElem.appendChild(nameColElem);
          return tableRowElem;
        }

        function makeCurrentTimeHeader(obj) {
          var tableRowElem = document.createElement('tr');
          var nameColElem = document.createElement('h5');
          nameColElem.textContent = getDisplayTextWODay(sliderControl.getNow().toString());
          tableRowElem.appendChild(nameColElem);
          return tableRowElem;
        }

        function makeRow(key, data) {
          var tableRowElem = document.createElement('tr');
          var nameColElem = document.createElement('td');
          var valueColElem = document.createElement('td');
          nameColElem.textContent = displayKey[key];
          if(typeof data[key] === 'object') {
            var newdata = data[key];
            for(var newkey of newdata) {
              var rowElem = makeRow(newkey, newdata);
              valueColElem.appendChild(rowElem);
            }
          } else {
            valueColElem.textContent = data[key];
          }
          tableRowElem.appendChild(nameColElem);
          tableRowElem.appendChild(valueColElem);
          return tableRowElem;
        }


        function jsonToTable(obj) {
          var wrapperTableElem = document.createElement('table');
          wrapperTableElem.classList.add('feature-table');

          var dongHeader = makeDongHeader(obj);
          wrapperTableElem.appendChild(dongHeader);

          var scopedObj = obj.population[sliderControl.getNow()]

          var timeHeader = makeCurrentTimeHeader(scopedObj);
          wrapperTableElem.appendChild(timeHeader);

          for (var key in scopedObj) {
              var tableRowElem = makeRow(key, scopedObj);
              wrapperTableElem.appendChild(tableRowElem);

          }

          return wrapperTableElem;
        }

        return {
          jsonToTable: jsonToTable
        }

    })();


    var onTangramClick = function (selection) {
      if (selection.feature) {
        var popup = L.popup()
                  .setLatLng(selection.leaflet_event.latlng)
                  .setContent(PopupPanel.jsonToTable(selection.feature.properties))
                  .openOn(map);
      }
    }

    var TabControl = L.Control.extend({
      initialize: function(opts) {
        this.tangramLayer = tangramLayer;
        this.tabs = opts.tabs;
        this.currentDataSources = tangramLayer.scene.sources;
        this.prevTab = this.tabs[0];
       },

      onAdd: function(map) {
        var containerDiv = L.DomUtil.create('div', 'tab-container');
        var self = this;

        L.DomEvent.disableClickPropagation(containerDiv);

        this.tabs.map((e, i) => {
          var wrapperDiv = L.DomUtil.create('div', 'tab');
          var oneTab = L.DomUtil.create('input', 'tab');
          oneTab.type = 'radio';
          oneTab.name ='tab';
          oneTab.id = e.value;
          if (i === 0) oneTab.checked = true;

          oneTab.onclick = function() {
            // set the data source first if there is none
            if (Object.keys(self.tangramLayer.scene.config.sources).findIndex((name => name===e.data[0].sourceName)) < 0) {
              e.data.map(elem => {
                self.tangramLayer.scene.setDataSource(elem.sourceName, elem.source);
              })
            }

            if (self.prevTab && self.prevTab.value !== e.value) {
              self.prevTab.data.map(elem => {
                self.tangramLayer.scene.config.layers[elem.layerName].enabled = false;
              })
              e.data.map(elem => {
                self.tangramLayer.scene.config.layers[elem.layerName].enabled = true;
              })
            }

            self.prevTab = e;
            self.tangramLayer.scene.updateConfig();
          }

          var tabLabel = L.DomUtil.create('label');
          tabLabel.textContent = e.displayText;
          tabLabel.for = e.value;

          wrapperDiv.appendChild(oneTab);
          wrapperDiv.appendChild(tabLabel);

          containerDiv.appendChild(wrapperDiv);
        })

        return containerDiv;
      }
    })


    //
    initMap();

    var sliderControl = new SliderControl({position: 'topright', tangramLayer: tangramLayer});
    sliderControl.addTo(map);

    var ageGroupUnit = 6;
    var ageGroupData = Array(ageGroupUnit).fill().map((f,idx) => idx)
                    .map((f,i) => ({
                      layerName: 'age'+i,
                      sourceName: 'tri'+i,
                      source:{
                        type: 'GeoJSON',
                        url: './geometries/triangle-key'+i+'.geojson'
                      }}))

    var tabControl = new TabControl({position: 'topright', tabs: [
      {
        value: 'total',
        displayText: '전체',
        data: [
          {
            layerName: 'dong',
            sourceName: 'hex',
            source: {
              type: 'GeoJSON',
              url: './geometries/hex.geojson'
            }
          }
        ]
      }, {
        value: 'sex',
        displayText: '성별',
        data: [
          {
            layerName: 'female',
            sourceName: 'half_hex_1',
            source: {
              type: 'GeoJSON',
              url: './geometries/half-key0.geojson'
            }
          }
        , {
          layerName: 'male',
          sourceName: 'half_hex_0',
          source: {
            type: 'GeoJSON',
            url: './geometries/half-key1.geojson'
          }
        }]
      }, {
        value: 'age',
        displayText: '연령군',
        data: ageGroupData}
    ]});

    tabControl.addTo(map);

  </script>
</body>
</html>
