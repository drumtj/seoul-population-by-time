<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>서울생활인구 · Population by time in Seoul</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
  integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
  crossorigin=""/>
  <link rel="stylesheet" href="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.min.css">
  <style>
  html,body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
  }
  #map {
    width: 100%;
    height: 100%;
  }

  .f-left {
    float: left;
  }

  button#play, button#pause {
    width: 60px;
    padding: 10px 5px;
    margin-right: 5px;
    cursor: pointer;
  }
  #timeLabel {
    margin-top: 5px;
  }
  .container {
    width: 300px;
    padding: 10px 20px 10px 20px;
    background-color: rgba(255, 255, 255, 0.7);
  }
  .slider-wrapper {
    margin-bottom: 40px;
  }
  /* noUISlider override */
  .noUi-horizontal {
    height: 10px;
  }
  .noUi-pips-horizontal {
    height: 0;
  }
  .noUi-horizontal .noUi-handle {
    height: 20px;
  }
  .noUi-handle:after, .noUi-handle:before {
    content: none;
  }
  .noUi-connect {
    background: #ccc;
    outline: 1px solid #333;
  }

  h3 {
    margin-top: 0;
  }
  label {
    font-size: 14px;
    font-weight: 700;
  }
  </style>
</head>
<body>
  <div id="map">
  </div>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
  integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
  crossorigin=""></script>
  <script src="https://unpkg.com/tangram@0.15.1/dist/tangram.min.js"></script>
  <script src="https://rawgit.com/leongersen/noUiSlider/master/distribute/nouislider.js"></script>
  <script>
    var timeUnit = 24;
    // This only works because it is not in between months
    var startingDate = 20180514;
    var endingDate = 20180520;

    var dayUnit = 7;

    var timeRange = Array(timeUnit).fill().map((f,idx) => idx);
    var dayRange = Array(dayUnit).fill().map((f,idx) => { return (startingDate + idx)});

    var totalTimeRange = Array(timeUnit * dayUnit)
                        .fill()
                        .map((f,idx) => {
                          var dayIndex = Math.floor(idx/timeUnit);
                          var timeIndex = Math.floor(idx%timeUnit)
                          var timeString = timeRange[timeIndex].toString();
                          if(timeString.length < 2) timeString = '0' + timeString;
                          return dayRange[dayIndex].toString() + timeString;
                        });
    var dayWords = '월화수목금토일';

    var slidingAnimValue = 0;


    var currentDayIndex = 0;
    var currentTimeIndex = 0;
    var currentDayTime = totalTimeRange[0];

    function initMap() {
      window.map = L.map('map');

      map.setView([37.58451, 126.96939], 12);

      window.tangramLayer = Tangram.leafletLayer({
        scene: {
          import: './timeline.yaml'
       },
       events: {
         click: function(selection) {
           onTangramClick(selection)
         }
       }
      })

      tangramLayer.addTo(map)
    }

    var PopupPanel = (function () {
        function makeCurrentPopulationTr(obj) {
          var tableRowElem = document.createElement('tr');
          var nameColElem = document.createElement('td');
          var valueColElem = document.createElement('td');
          nameColElem.textContent = getDisplayText(currentDayTime);
          valueColElem.textContent = obj[currentDayTime];

          tableRowElem.appendChild(nameColElem);
          tableRowElem.appendChild(valueColElem);
          return tableRowElem;
        }

        function jsonToTable(obj) {
          var wrapperTableElem = document.createElement('table');
          wrapperTableElem.classList.add('feature-table');
          for (var key in obj) {
              if (key !== 'population') {
                var tableRowElem = document.createElement('tr');
                var nameColElem = document.createElement('td');
                var valueColElem = document.createElement('td');
                nameColElem.textContent = key;
                valueColElem.textContent = obj[key];
                tableRowElem.appendChild(nameColElem);
                tableRowElem.appendChild(valueColElem);
                wrapperTableElem.appendChild(tableRowElem);
            }
          }
          var populationElem = makeCurrentPopulationTr(obj['population']);
          wrapperTableElem.appendChild(populationElem);
          return wrapperTableElem;
        }

        return {
          jsonToTable: jsonToTable
        }

    })();


    var onTangramClick = function (selection) {
      if (selection.feature) {
        var popup = L.popup()
                  .setLatLng(selection.leaflet_event.latlng)
                  .setContent(PopupPanel.jsonToTable(selection.feature.properties))
                  .openOn(map);
      }
    }


    var animate = function (timeSlider, daySlider, timeH) {

        if (slidingAnimValue < totalTimeRange.length) {
          slidingAnimValue+=0.1;
        } else {
          slidingAnimValue = 0;
        }
        updateTangram(slidingAnimValue);
        currentDayTime = totalTimeRange[Math.floor(slidingAnimValue)];
        console.log(currentDayTime)
        timeH.textContent = getDisplayText(currentDayTime);

        var integerSlidingVal = Math.round(slidingAnimValue);
        if (Math.abs(slidingAnimValue - integerSlidingVal) < 0.00001 ) {
          timeSlider.noUiSlider.set(integerSlidingVal%timeUnit);
          daySlider.noUiSlider.set(Math.floor(integerSlidingVal/timeUnit));
          currentDayIndex = Math.floor(integerSlidingVal/timeUnit);
          currentTimeIndex = integerSlidingVal%timeUnit;
          currentDayTime = totalTimeRange[getTimeIndex(currentDayIndex, currentTimeIndex)];

        }

    }


    var setAnimation = function(timeSlider, daySlider, timeH) {
      if(!window.intervalID) {
        slidingAnimValue = totalTimeRange.indexOf(currentDayTime);
        updateTangram(slidingAnimValue);
        window.intervalID = setInterval(function() {
          animate(timeSlider, daySlider, timeH)
        }, 10);
      }
    }

    var updateTangram = function(idx) {
      tangramLayer.scene.styles.dongStyle.shaders.uniforms.u_offset = idx;
    }

    var sliderControl = L.control({position: 'topright'});

    sliderControl.onAdd = function () {
      var containerDiv = L.DomUtil.create('div', 'container');
      var titleH = L.DomUtil.create('h3');
      titleH.textContent = '서울생활인구 Populations by time in Seoul';
      var timeH = L.DomUtil.create('h3');
      timeH.id = 'timeLabel';
      timeH.classList.add('f-left')
      timeH.textContent = getDisplayText(totalTimeRange[0]);

      var timeSliderDiv = L.DomUtil.create('div', 'slider-wrapper');
      var dateLabel = L.DomUtil.create('label');
      dateLabel.textContent = '시간';
      timeSliderDiv.id = 'tileSlider';

      var daySliderDiv = L.DomUtil.create('div', 'slider-wrapper');
      var dayLabel = L.DomUtil.create('label');
      dayLabel.textContent = '일';
      daySliderDiv.id = 'daySlider';

      noUiSlider.create(timeSliderDiv, {
        start: 0,
        connect: true,
        step: 1,
        tooltips: false,
        range: {
          'min': 0,
          'max': 23
        },
        format: {
          to: function (value) {
            return value;
          },
          from: function (value) {
            return value;
          }
        },
        pips: { // Show a scale with the slider
          mode: 'positions',
          stepped: true,
          density: 20,
          values: [0,25,50,75,100]
        }
      });


      noUiSlider.create(daySliderDiv, {
        start: 0,
        connect: true,
        step: 1,
        tooltips: false,
        range: {
          'min': 0,
          'max': 6
        },
        format: {
          to: function (value) {
            return value;
          },
          from: function (value) {
            return value;
          }
        },
        pips: { // Show a scale with the slider
          mode: 'positions',
          stepped: true,
          density: 100/7,
          values: [0,100]
        }
      });


      var playButton = L.DomUtil.create('button');
      playButton.id = 'play';
      playButton.classList.add('f-left');
      playButton.textContent = 'play';

      var pauseButton = L.DomUtil.create('button');
      pauseButton.id = 'pause';
      pauseButton.classList.add('f-left');
      pauseButton.textContent = 'pause';



      playButton.onclick = function () {
        setAnimation(timeSliderDiv, daySliderDiv, timeH);
      }

      pauseButton.onclick = function () {
        if(window.intervalID) {
          clearInterval(window.intervalID);
          window.intervalID = null;
        }
      }

      timeSliderDiv.noUiSlider.on('change', function ( values, handle ) {
        let idx = Math.round(values[handle]);
        currentTimeIndex = idx;
        currentDayTime = totalTimeRange[getTimeIndex(currentDayIndex, currentTimeIndex)];
        updateTangram(totalTimeRange.indexOf(currentDayTime));
        timeH.textContent = getDisplayText(currentDayTime);
      });

      daySliderDiv.noUiSlider.on('change', function ( values, handle ) {
        let idx = Math.floor(values[handle]);
        currentDayIndex = idx;
        currentDayTime = totalTimeRange[getTimeIndex(currentDayIndex, currentTimeIndex)];
        updateTangram(totalTimeRange.indexOf(currentDayTime));
        timeH.textContent = getDisplayText(currentDayTime);
      });

      L.DomEvent.disableClickPropagation(containerDiv);

      containerDiv.appendChild(titleH);

      containerDiv.appendChild(dateLabel);
      containerDiv.appendChild(timeSliderDiv);

      containerDiv.appendChild(dayLabel);
      containerDiv.appendChild(daySliderDiv);

      containerDiv.appendChild(playButton);
      containerDiv.appendChild(pauseButton);
      containerDiv.appendChild(timeH);

      return containerDiv;
    }





    function getTimeIndex(d, t) {
      return (d*24 + t);
    }

    function getDisplayText(s) {
      return s[0]+s[1]+s[2]+s[3]+'/ '+s[4]+s[5] + '/ ' + s[6] +s[7] + '  '+ s[8]+s[9]+'시'+ ' ' + dayWords[currentDayIndex]+'요일';
    }


    //
    initMap();
    sliderControl.addTo(map);

  </script>
</body>
</html>
